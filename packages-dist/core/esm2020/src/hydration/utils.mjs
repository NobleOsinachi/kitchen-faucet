/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { PLATFORM_ID, TRANSFER_STATE } from '../application_tokens';
import { ViewEncapsulation } from '../metadata/view';
import { getDocument } from '../render3/interfaces/document';
import { isRootView } from '../render3/interfaces/type_checks';
import { HEADER_OFFSET } from '../render3/interfaces/view';
import { assertDefined } from '../util/assert';
import { NGH_DATA_KEY } from './annotate';
import { IS_HYDRATION_FEATURE_ENABLED } from './api';
import { NODES } from './interfaces';
export const NGH_ATTR_NAME = 'ngh';
export const EMPTY_TEXT_NODE_COMMENT = 'ngetn';
export const TEXT_NODE_SEPARATOR_COMMENT = 'ngtns';
/**
 * Reference to a function that reads `ngh` attribute from
 * a given RNode. Returns `null` by default, when hydration is not enabled.
 * @param rNode
 */
let _retrieveNghInfoImpl = (rNode, injector) => null;
function retrieveNghInfoImpl(rNode, injector) {
    const nghAttrValue = rNode.getAttribute(NGH_ATTR_NAME);
    const transferState = injector.get(TRANSFER_STATE, null, { optional: true });
    if (transferState !== null) {
        const nghData = transferState.get(NGH_DATA_KEY, []) ?? [];
        if (nghAttrValue != null) {
            let data = {};
            if (nghAttrValue !== '') {
                data = nghData[Number(nghAttrValue)];
                // If the `ngh` attribute exists and has a non-empty value,
                // the hydration info *must* be present in the TransferState.
                // If there is no data for some reasons, this is an error.
                ngDevMode &&
                    assertDefined(data, 'Unable to retrieve hydration info from the TransferState.');
            }
            const nghDomInstance = {
                data,
                firstChild: rNode.firstChild,
            };
            rNode.removeAttribute(NGH_ATTR_NAME);
            // Note: don't check whether this node was claimed for hydration,
            // because this node might've been previously claimed while processing
            // template instructions.
            ngDevMode && markRNodeAsClaimedForHydration(rNode, /* checkIfAlreadyClaimed */ false);
            ngDevMode && ngDevMode.hydratedComponents++;
            return nghDomInstance;
        }
    }
    return null;
}
export function enableRetrieveNghInfoImpl() {
    _retrieveNghInfoImpl = retrieveNghInfoImpl;
}
export function retrieveNghInfo(rNode, injector) {
    return _retrieveNghInfoImpl(rNode, injector);
}
export function getComponentLView(viewRef) {
    let lView = viewRef._lView;
    if (isRootView(lView)) {
        lView = lView[HEADER_OFFSET];
    }
    return lView;
}
export function processTextNodeMarkersBeforeHydration(node) {
    const doc = getDocument();
    const commentIterator = doc.createNodeIterator(node, NodeFilter.SHOW_COMMENT, {
        acceptNode(node) {
            const content = node.textContent;
            const isTextNodeMarker = content === EMPTY_TEXT_NODE_COMMENT || content === TEXT_NODE_SEPARATOR_COMMENT;
            return isTextNodeMarker ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
        }
    });
    let currentNode;
    while (currentNode = commentIterator.nextNode()) {
        if (currentNode.textContent === EMPTY_TEXT_NODE_COMMENT) {
            currentNode.replaceWith(doc.createTextNode(''));
        }
        else {
            currentNode.remove();
        }
    }
}
export function locateHostElementImpl(renderer, elementOrSelector, encapsulation, injector) {
    const isHydrationEnabled = injector.get(IS_HYDRATION_FEATURE_ENABLED, false);
    // FIXME: this is a fix to the problem that happens in tests :(
    // We load extra code from `provideHydrationSupport` fn, but it is retained
    // throughout the execution of all tests, thus also making it into
    // SSR code path. We should investigate how to avoid this check here.
    const isBrowser = injector.get(PLATFORM_ID) === 'browser';
    const preserveContent = (isBrowser && isHydrationEnabled) || encapsulation === ViewEncapsulation.ShadowDom;
    const rootElement = renderer.selectRootElement(elementOrSelector, preserveContent);
    if (isHydrationEnabled) {
        processTextNodeMarkersBeforeHydration(rootElement);
    }
    return rootElement;
}
;
// TODO: consider using WeakMap instead.
export function markRNodeAsClaimedForHydration(node, checkIfAlreadyClaimed = true) {
    if (!ngDevMode) {
        throw new Error('Calling `claimNode` in prod mode is not supported and likely a mistake.');
    }
    if (checkIfAlreadyClaimed && isRNodeClaimedForHydration(node)) {
        throw new Error('Trying to claim a node, which was claimed already.');
    }
    node.__claimed = true;
    ngDevMode.hydratedNodes++;
}
export function isRNodeClaimedForHydration(node) {
    return !!node.__claimed;
}
/**
 * Special marker that indicates that this node was dropped
 * during content projection. We need to re-create this node
 * from scratch during hydration.
 */
export const DROPPED_PROJECTED_NODE = 'd';
/**
 * Checks whether a node is annotated as "disconnected", i.e. not present
 * in live DOM at serialization time.
 */
export function isNodeDisconnected(hydrationInfo, index) {
    return hydrationInfo.data[NODES]?.[index] === DROPPED_PROJECTED_NODE;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9oeWRyYXRpb24vdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsT0FBTyxFQUFDLFdBQVcsRUFBRSxjQUFjLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUdsRSxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUNuRCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFHM0QsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLG1DQUFtQyxDQUFDO0FBQzdELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUN6RCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0MsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLFlBQVksQ0FBQztBQUN4QyxPQUFPLEVBQUMsNEJBQTRCLEVBQUMsTUFBTSxPQUFPLENBQUM7QUFDbkQsT0FBTyxFQUF5QixLQUFLLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFFM0QsTUFBTSxDQUFDLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQztBQUNuQyxNQUFNLENBQUMsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUM7QUFDL0MsTUFBTSxDQUFDLE1BQU0sMkJBQTJCLEdBQUcsT0FBTyxDQUFDO0FBRW5EOzs7O0dBSUc7QUFDSCxJQUFJLG9CQUFvQixHQUErQixDQUFDLEtBQWUsRUFBRSxRQUFrQixFQUFFLEVBQUUsQ0FDM0YsSUFBSSxDQUFDO0FBRVQsU0FBUyxtQkFBbUIsQ0FBQyxLQUFlLEVBQUUsUUFBa0I7SUFDOUQsTUFBTSxZQUFZLEdBQUksS0FBcUIsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDeEUsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsSUFBSSxFQUFFLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7SUFDM0UsSUFBSSxhQUFhLEtBQUssSUFBSSxFQUFFO1FBQzFCLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxRCxJQUFJLFlBQVksSUFBSSxJQUFJLEVBQUU7WUFDeEIsSUFBSSxJQUFJLEdBQVcsRUFBRSxDQUFDO1lBQ3RCLElBQUksWUFBWSxLQUFLLEVBQUUsRUFBRTtnQkFDdkIsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFFckMsMkRBQTJEO2dCQUMzRCw2REFBNkQ7Z0JBQzdELDBEQUEwRDtnQkFDMUQsU0FBUztvQkFDTCxhQUFhLENBQUMsSUFBSSxFQUFFLDJEQUEyRCxDQUFDLENBQUM7YUFDdEY7WUFDRCxNQUFNLGNBQWMsR0FBbUI7Z0JBQ3JDLElBQUk7Z0JBQ0osVUFBVSxFQUFHLEtBQXFCLENBQUMsVUFBeUI7YUFDN0QsQ0FBQztZQUNGLEtBQUssQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDckMsaUVBQWlFO1lBQ2pFLHNFQUFzRTtZQUN0RSx5QkFBeUI7WUFDekIsU0FBUyxJQUFJLDhCQUE4QixDQUFDLEtBQUssRUFBRSwyQkFBMkIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0RixTQUFTLElBQUksU0FBUyxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFFNUMsT0FBTyxjQUFjLENBQUM7U0FDdkI7S0FDRjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELE1BQU0sVUFBVSx5QkFBeUI7SUFDdkMsb0JBQW9CLEdBQUcsbUJBQW1CLENBQUM7QUFDN0MsQ0FBQztBQUVELE1BQU0sVUFBVSxlQUFlLENBQUMsS0FBZSxFQUFFLFFBQWtCO0lBQ2pFLE9BQU8sb0JBQW9CLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQy9DLENBQUM7QUFFRCxNQUFNLFVBQVUsaUJBQWlCLENBQUMsT0FBZ0I7SUFDaEQsSUFBSSxLQUFLLEdBQUksT0FBZSxDQUFDLE1BQU0sQ0FBQztJQUNwQyxJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUNyQixLQUFLLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0tBQzlCO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBT0QsTUFBTSxVQUFVLHFDQUFxQyxDQUFDLElBQWlCO0lBQ3JFLE1BQU0sR0FBRyxHQUFHLFdBQVcsRUFBRSxDQUFDO0lBQzFCLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLFlBQVksRUFBRTtRQUM1RSxVQUFVLENBQUMsSUFBSTtZQUNiLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDakMsTUFBTSxnQkFBZ0IsR0FDbEIsT0FBTyxLQUFLLHVCQUF1QixJQUFJLE9BQU8sS0FBSywyQkFBMkIsQ0FBQztZQUNuRixPQUFPLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDO1FBQ2hGLENBQUM7S0FDRixDQUFDLENBQUM7SUFDSCxJQUFJLFdBQW9CLENBQUM7SUFDekIsT0FBTyxXQUFXLEdBQUcsZUFBZSxDQUFDLFFBQVEsRUFBYSxFQUFFO1FBQzFELElBQUksV0FBVyxDQUFDLFdBQVcsS0FBSyx1QkFBdUIsRUFBRTtZQUN2RCxXQUFXLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNqRDthQUFNO1lBQ0wsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ3RCO0tBQ0Y7QUFDSCxDQUFDO0FBRUQsTUFBTSxVQUFVLHFCQUFxQixDQUNqQyxRQUFrQixFQUFFLGlCQUFrQyxFQUFFLGFBQWdDLEVBQ3hGLFFBQWtCO0lBQ3BCLE1BQU0sa0JBQWtCLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUU3RSwrREFBK0Q7SUFDL0QsMkVBQTJFO0lBQzNFLGtFQUFrRTtJQUNsRSxxRUFBcUU7SUFDckUsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsS0FBSyxTQUFTLENBQUM7SUFFMUQsTUFBTSxlQUFlLEdBQ2pCLENBQUMsU0FBUyxJQUFJLGtCQUFrQixDQUFDLElBQUksYUFBYSxLQUFLLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztJQUN2RixNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDbkYsSUFBSSxrQkFBa0IsRUFBRTtRQUN0QixxQ0FBcUMsQ0FBQyxXQUEwQixDQUFDLENBQUM7S0FDbkU7SUFDRCxPQUFPLFdBQVcsQ0FBQztBQUNyQixDQUFDO0FBQUEsQ0FBQztBQUVGLHdDQUF3QztBQUN4QyxNQUFNLFVBQVUsOEJBQThCLENBQUMsSUFBVyxFQUFFLHFCQUFxQixHQUFHLElBQUk7SUFDdEYsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMseUVBQXlFLENBQUMsQ0FBQztLQUM1RjtJQUNELElBQUkscUJBQXFCLElBQUksMEJBQTBCLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDN0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxvREFBb0QsQ0FBQyxDQUFDO0tBQ3ZFO0lBQ0EsSUFBb0IsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO0lBQ3ZDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUM1QixDQUFDO0FBRUQsTUFBTSxVQUFVLDBCQUEwQixDQUFDLElBQVc7SUFDcEQsT0FBTyxDQUFDLENBQUUsSUFBb0IsQ0FBQyxTQUFTLENBQUM7QUFDM0MsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxNQUFNLENBQUMsTUFBTSxzQkFBc0IsR0FBRyxHQUFHLENBQUM7QUFFMUM7OztHQUdHO0FBQ0gsTUFBTSxVQUFVLGtCQUFrQixDQUFDLGFBQTZCLEVBQUUsS0FBYTtJQUM3RSxPQUFPLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxzQkFBc0IsQ0FBQztBQUN2RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7UExBVEZPUk1fSUQsIFRSQU5TRkVSX1NUQVRFfSBmcm9tICcuLi9hcHBsaWNhdGlvbl90b2tlbnMnO1xuaW1wb3J0IHtJbmplY3Rvcn0gZnJvbSAnLi4vZGkvaW5qZWN0b3InO1xuaW1wb3J0IHtWaWV3UmVmfSBmcm9tICcuLi9saW5rZXInO1xuaW1wb3J0IHtWaWV3RW5jYXBzdWxhdGlvbn0gZnJvbSAnLi4vbWV0YWRhdGEvdmlldyc7XG5pbXBvcnQge2dldERvY3VtZW50fSBmcm9tICcuLi9yZW5kZXIzL2ludGVyZmFjZXMvZG9jdW1lbnQnO1xuaW1wb3J0IHtSZW5kZXJlcn0gZnJvbSAnLi4vcmVuZGVyMy9pbnRlcmZhY2VzL3JlbmRlcmVyJztcbmltcG9ydCB7UkVsZW1lbnQsIFJOb2RlfSBmcm9tICcuLi9yZW5kZXIzL2ludGVyZmFjZXMvcmVuZGVyZXJfZG9tJztcbmltcG9ydCB7aXNSb290Vmlld30gZnJvbSAnLi4vcmVuZGVyMy9pbnRlcmZhY2VzL3R5cGVfY2hlY2tzJztcbmltcG9ydCB7SEVBREVSX09GRlNFVH0gZnJvbSAnLi4vcmVuZGVyMy9pbnRlcmZhY2VzL3ZpZXcnO1xuaW1wb3J0IHthc3NlcnREZWZpbmVkfSBmcm9tICcuLi91dGlsL2Fzc2VydCc7XG5cbmltcG9ydCB7TkdIX0RBVEFfS0VZfSBmcm9tICcuL2Fubm90YXRlJztcbmltcG9ydCB7SVNfSFlEUkFUSU9OX0ZFQVRVUkVfRU5BQkxFRH0gZnJvbSAnLi9hcGknO1xuaW1wb3J0IHtOZ2hEb20sIE5naERvbUluc3RhbmNlLCBOT0RFU30gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuZXhwb3J0IGNvbnN0IE5HSF9BVFRSX05BTUUgPSAnbmdoJztcbmV4cG9ydCBjb25zdCBFTVBUWV9URVhUX05PREVfQ09NTUVOVCA9ICduZ2V0bic7XG5leHBvcnQgY29uc3QgVEVYVF9OT0RFX1NFUEFSQVRPUl9DT01NRU5UID0gJ25ndG5zJztcblxuLyoqXG4gKiBSZWZlcmVuY2UgdG8gYSBmdW5jdGlvbiB0aGF0IHJlYWRzIGBuZ2hgIGF0dHJpYnV0ZSBmcm9tXG4gKiBhIGdpdmVuIFJOb2RlLiBSZXR1cm5zIGBudWxsYCBieSBkZWZhdWx0LCB3aGVuIGh5ZHJhdGlvbiBpcyBub3QgZW5hYmxlZC5cbiAqIEBwYXJhbSByTm9kZVxuICovXG5sZXQgX3JldHJpZXZlTmdoSW5mb0ltcGw6IHR5cGVvZiByZXRyaWV2ZU5naEluZm9JbXBsID0gKHJOb2RlOiBSRWxlbWVudCwgaW5qZWN0b3I6IEluamVjdG9yKSA9PlxuICAgIG51bGw7XG5cbmZ1bmN0aW9uIHJldHJpZXZlTmdoSW5mb0ltcGwock5vZGU6IFJFbGVtZW50LCBpbmplY3RvcjogSW5qZWN0b3IpOiBOZ2hEb21JbnN0YW5jZXxudWxsIHtcbiAgY29uc3QgbmdoQXR0clZhbHVlID0gKHJOb2RlIGFzIEhUTUxFbGVtZW50KS5nZXRBdHRyaWJ1dGUoTkdIX0FUVFJfTkFNRSk7XG4gIGNvbnN0IHRyYW5zZmVyU3RhdGUgPSBpbmplY3Rvci5nZXQoVFJBTlNGRVJfU1RBVEUsIG51bGwsIHtvcHRpb25hbDogdHJ1ZX0pO1xuICBpZiAodHJhbnNmZXJTdGF0ZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IG5naERhdGEgPSB0cmFuc2ZlclN0YXRlLmdldChOR0hfREFUQV9LRVksIFtdKSA/PyBbXTtcbiAgICBpZiAobmdoQXR0clZhbHVlICE9IG51bGwpIHtcbiAgICAgIGxldCBkYXRhOiBOZ2hEb20gPSB7fTtcbiAgICAgIGlmIChuZ2hBdHRyVmFsdWUgIT09ICcnKSB7XG4gICAgICAgIGRhdGEgPSBuZ2hEYXRhW051bWJlcihuZ2hBdHRyVmFsdWUpXTtcblxuICAgICAgICAvLyBJZiB0aGUgYG5naGAgYXR0cmlidXRlIGV4aXN0cyBhbmQgaGFzIGEgbm9uLWVtcHR5IHZhbHVlLFxuICAgICAgICAvLyB0aGUgaHlkcmF0aW9uIGluZm8gKm11c3QqIGJlIHByZXNlbnQgaW4gdGhlIFRyYW5zZmVyU3RhdGUuXG4gICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGRhdGEgZm9yIHNvbWUgcmVhc29ucywgdGhpcyBpcyBhbiBlcnJvci5cbiAgICAgICAgbmdEZXZNb2RlICYmXG4gICAgICAgICAgICBhc3NlcnREZWZpbmVkKGRhdGEsICdVbmFibGUgdG8gcmV0cmlldmUgaHlkcmF0aW9uIGluZm8gZnJvbSB0aGUgVHJhbnNmZXJTdGF0ZS4nKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5naERvbUluc3RhbmNlOiBOZ2hEb21JbnN0YW5jZSA9IHtcbiAgICAgICAgZGF0YSxcbiAgICAgICAgZmlyc3RDaGlsZDogKHJOb2RlIGFzIEhUTUxFbGVtZW50KS5maXJzdENoaWxkIGFzIEhUTUxFbGVtZW50LFxuICAgICAgfTtcbiAgICAgIHJOb2RlLnJlbW92ZUF0dHJpYnV0ZShOR0hfQVRUUl9OQU1FKTtcbiAgICAgIC8vIE5vdGU6IGRvbid0IGNoZWNrIHdoZXRoZXIgdGhpcyBub2RlIHdhcyBjbGFpbWVkIGZvciBoeWRyYXRpb24sXG4gICAgICAvLyBiZWNhdXNlIHRoaXMgbm9kZSBtaWdodCd2ZSBiZWVuIHByZXZpb3VzbHkgY2xhaW1lZCB3aGlsZSBwcm9jZXNzaW5nXG4gICAgICAvLyB0ZW1wbGF0ZSBpbnN0cnVjdGlvbnMuXG4gICAgICBuZ0Rldk1vZGUgJiYgbWFya1JOb2RlQXNDbGFpbWVkRm9ySHlkcmF0aW9uKHJOb2RlLCAvKiBjaGVja0lmQWxyZWFkeUNsYWltZWQgKi8gZmFsc2UpO1xuICAgICAgbmdEZXZNb2RlICYmIG5nRGV2TW9kZS5oeWRyYXRlZENvbXBvbmVudHMrKztcblxuICAgICAgcmV0dXJuIG5naERvbUluc3RhbmNlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVuYWJsZVJldHJpZXZlTmdoSW5mb0ltcGwoKSB7XG4gIF9yZXRyaWV2ZU5naEluZm9JbXBsID0gcmV0cmlldmVOZ2hJbmZvSW1wbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJldHJpZXZlTmdoSW5mbyhyTm9kZTogUkVsZW1lbnQsIGluamVjdG9yOiBJbmplY3Rvcik6IE5naERvbUluc3RhbmNlfG51bGwge1xuICByZXR1cm4gX3JldHJpZXZlTmdoSW5mb0ltcGwock5vZGUsIGluamVjdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbXBvbmVudExWaWV3KHZpZXdSZWY6IFZpZXdSZWYpIHtcbiAgbGV0IGxWaWV3ID0gKHZpZXdSZWYgYXMgYW55KS5fbFZpZXc7XG4gIGlmIChpc1Jvb3RWaWV3KGxWaWV3KSkge1xuICAgIGxWaWV3ID0gbFZpZXdbSEVBREVSX09GRlNFVF07XG4gIH1cbiAgcmV0dXJuIGxWaWV3O1xufVxuXG5cbnR5cGUgQ2xhaW1lZE5vZGUgPSB7XG4gIF9fY2xhaW1lZD86IGJvb2xlYW5cbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9jZXNzVGV4dE5vZGVNYXJrZXJzQmVmb3JlSHlkcmF0aW9uKG5vZGU6IEhUTUxFbGVtZW50KSB7XG4gIGNvbnN0IGRvYyA9IGdldERvY3VtZW50KCk7XG4gIGNvbnN0IGNvbW1lbnRJdGVyYXRvciA9IGRvYy5jcmVhdGVOb2RlSXRlcmF0b3Iobm9kZSwgTm9kZUZpbHRlci5TSE9XX0NPTU1FTlQsIHtcbiAgICBhY2NlcHROb2RlKG5vZGUpIHtcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBub2RlLnRleHRDb250ZW50O1xuICAgICAgY29uc3QgaXNUZXh0Tm9kZU1hcmtlciA9XG4gICAgICAgICAgY29udGVudCA9PT0gRU1QVFlfVEVYVF9OT0RFX0NPTU1FTlQgfHwgY29udGVudCA9PT0gVEVYVF9OT0RFX1NFUEFSQVRPUl9DT01NRU5UO1xuICAgICAgcmV0dXJuIGlzVGV4dE5vZGVNYXJrZXIgPyBOb2RlRmlsdGVyLkZJTFRFUl9BQ0NFUFQgOiBOb2RlRmlsdGVyLkZJTFRFUl9SRUpFQ1Q7XG4gICAgfVxuICB9KTtcbiAgbGV0IGN1cnJlbnROb2RlOiBDb21tZW50O1xuICB3aGlsZSAoY3VycmVudE5vZGUgPSBjb21tZW50SXRlcmF0b3IubmV4dE5vZGUoKSBhcyBDb21tZW50KSB7XG4gICAgaWYgKGN1cnJlbnROb2RlLnRleHRDb250ZW50ID09PSBFTVBUWV9URVhUX05PREVfQ09NTUVOVCkge1xuICAgICAgY3VycmVudE5vZGUucmVwbGFjZVdpdGgoZG9jLmNyZWF0ZVRleHROb2RlKCcnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGN1cnJlbnROb2RlLnJlbW92ZSgpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbG9jYXRlSG9zdEVsZW1lbnRJbXBsKFxuICAgIHJlbmRlcmVyOiBSZW5kZXJlciwgZWxlbWVudE9yU2VsZWN0b3I6IFJFbGVtZW50fHN0cmluZywgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24sXG4gICAgaW5qZWN0b3I6IEluamVjdG9yKTogUkVsZW1lbnQge1xuICBjb25zdCBpc0h5ZHJhdGlvbkVuYWJsZWQgPSBpbmplY3Rvci5nZXQoSVNfSFlEUkFUSU9OX0ZFQVRVUkVfRU5BQkxFRCwgZmFsc2UpO1xuXG4gIC8vIEZJWE1FOiB0aGlzIGlzIGEgZml4IHRvIHRoZSBwcm9ibGVtIHRoYXQgaGFwcGVucyBpbiB0ZXN0cyA6KFxuICAvLyBXZSBsb2FkIGV4dHJhIGNvZGUgZnJvbSBgcHJvdmlkZUh5ZHJhdGlvblN1cHBvcnRgIGZuLCBidXQgaXQgaXMgcmV0YWluZWRcbiAgLy8gdGhyb3VnaG91dCB0aGUgZXhlY3V0aW9uIG9mIGFsbCB0ZXN0cywgdGh1cyBhbHNvIG1ha2luZyBpdCBpbnRvXG4gIC8vIFNTUiBjb2RlIHBhdGguIFdlIHNob3VsZCBpbnZlc3RpZ2F0ZSBob3cgdG8gYXZvaWQgdGhpcyBjaGVjayBoZXJlLlxuICBjb25zdCBpc0Jyb3dzZXIgPSBpbmplY3Rvci5nZXQoUExBVEZPUk1fSUQpID09PSAnYnJvd3Nlcic7XG5cbiAgY29uc3QgcHJlc2VydmVDb250ZW50ID1cbiAgICAgIChpc0Jyb3dzZXIgJiYgaXNIeWRyYXRpb25FbmFibGVkKSB8fCBlbmNhcHN1bGF0aW9uID09PSBWaWV3RW5jYXBzdWxhdGlvbi5TaGFkb3dEb207XG4gIGNvbnN0IHJvb3RFbGVtZW50ID0gcmVuZGVyZXIuc2VsZWN0Um9vdEVsZW1lbnQoZWxlbWVudE9yU2VsZWN0b3IsIHByZXNlcnZlQ29udGVudCk7XG4gIGlmIChpc0h5ZHJhdGlvbkVuYWJsZWQpIHtcbiAgICBwcm9jZXNzVGV4dE5vZGVNYXJrZXJzQmVmb3JlSHlkcmF0aW9uKHJvb3RFbGVtZW50IGFzIEhUTUxFbGVtZW50KTtcbiAgfVxuICByZXR1cm4gcm9vdEVsZW1lbnQ7XG59O1xuXG4vLyBUT0RPOiBjb25zaWRlciB1c2luZyBXZWFrTWFwIGluc3RlYWQuXG5leHBvcnQgZnVuY3Rpb24gbWFya1JOb2RlQXNDbGFpbWVkRm9ySHlkcmF0aW9uKG5vZGU6IFJOb2RlLCBjaGVja0lmQWxyZWFkeUNsYWltZWQgPSB0cnVlKSB7XG4gIGlmICghbmdEZXZNb2RlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYWxsaW5nIGBjbGFpbU5vZGVgIGluIHByb2QgbW9kZSBpcyBub3Qgc3VwcG9ydGVkIGFuZCBsaWtlbHkgYSBtaXN0YWtlLicpO1xuICB9XG4gIGlmIChjaGVja0lmQWxyZWFkeUNsYWltZWQgJiYgaXNSTm9kZUNsYWltZWRGb3JIeWRyYXRpb24obm9kZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBjbGFpbSBhIG5vZGUsIHdoaWNoIHdhcyBjbGFpbWVkIGFscmVhZHkuJyk7XG4gIH1cbiAgKG5vZGUgYXMgQ2xhaW1lZE5vZGUpLl9fY2xhaW1lZCA9IHRydWU7XG4gIG5nRGV2TW9kZS5oeWRyYXRlZE5vZGVzKys7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1JOb2RlQ2xhaW1lZEZvckh5ZHJhdGlvbihub2RlOiBSTm9kZSk6IGJvb2xlYW4ge1xuICByZXR1cm4gISEobm9kZSBhcyBDbGFpbWVkTm9kZSkuX19jbGFpbWVkO1xufVxuXG4vKipcbiAqIFNwZWNpYWwgbWFya2VyIHRoYXQgaW5kaWNhdGVzIHRoYXQgdGhpcyBub2RlIHdhcyBkcm9wcGVkXG4gKiBkdXJpbmcgY29udGVudCBwcm9qZWN0aW9uLiBXZSBuZWVkIHRvIHJlLWNyZWF0ZSB0aGlzIG5vZGVcbiAqIGZyb20gc2NyYXRjaCBkdXJpbmcgaHlkcmF0aW9uLlxuICovXG5leHBvcnQgY29uc3QgRFJPUFBFRF9QUk9KRUNURURfTk9ERSA9ICdkJztcblxuLyoqXG4gKiBDaGVja3Mgd2hldGhlciBhIG5vZGUgaXMgYW5ub3RhdGVkIGFzIFwiZGlzY29ubmVjdGVkXCIsIGkuZS4gbm90IHByZXNlbnRcbiAqIGluIGxpdmUgRE9NIGF0IHNlcmlhbGl6YXRpb24gdGltZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzTm9kZURpc2Nvbm5lY3RlZChoeWRyYXRpb25JbmZvOiBOZ2hEb21JbnN0YW5jZSwgaW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xuICByZXR1cm4gaHlkcmF0aW9uSW5mby5kYXRhW05PREVTXT8uW2luZGV4XSA9PT0gRFJPUFBFRF9QUk9KRUNURURfTk9ERTtcbn1cbiJdfQ==